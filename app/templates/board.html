
<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
  <title>Chesski Move Trainer</title>
  <base href="../" />
  <link rel="stylesheet" href="css/chessboard-1.0.0.css">
</head>
<body>

<!--- Begin Example HTML ------------------------------------------------------>
<div id="myBoard" style="width: 400px"></div>
<!--- End Example HTML -------------------------------------------------------->
<button onclick="loadPuzzle()">Next Puzzle</button>

<script src="js/jquery-3.4.1.min.js"></script>
<script src="js/chessboard-1.0.0.js" ></script>
<script>
// --- Begin Example JS --------------------------------------------------------

let idx = 0
let playerTurn = true;
let puzzle = {
    "startingPostion": "r1bq1rk1/pppp1pp1/2n4p/2b1p3/2B1P1n1/2NP1N2/PPPB1PPP/R2Q1RK1 b - - 3 8",
    "moves": [
        {"start": "f3", "end": "e5"},
        {"start": "f7", "end": "f6"},
    ]
}

function computesMove () {
  if (playerTurn === false || idx < puzzle.moves.length) {
    let computersMove = puzzle.moves[idx];
    board.move(computersMove.start + "-" + computersMove.end);
    playerTurn = true;
    idx++;
  }
}

function onDrop (source, target, piece, newPos, oldPos, orientation) {
    if (!playerTurn){
        return 'snapback'
    }
    if (puzzle.moves[idx].start === source && puzzle.moves[idx].end === target) {
        board.move(puzzle.moves[idx].start, puzzle.moves[idx].end)
        idx++
        if (idx === puzzle.moves.length) {
          console.log("Puzzle solved")
        }
        playerTurn = false;
        computesMove();
        return;
    } else {
        console.log("Wrong move!")
        return 'snapback'
    }
}

function setInitialBoardState() {
  let board = ChessBoard('myBoard', {
    position: 'start',
    moveSpeed: 'slow',
    showNotation: true,
    draggable: true,
    onDrop: onDrop,
  });
  return board;
}

function updateBoard(payload) {
  puzzle = JSON.parse(payload);
  console.log(puzzle);
  board.position(puzzle.startingPosition);
  board.orientation(puzzle.orientation);
}

function loadPuzzle() {
  let xhr = new XMLHttpRequest();
  xhr.onreadystatechange = function() {
    if (xhr.readyState === 4) {
      updateBoard(xhr.responseText);
    }
  }
  xhr.overrideMimeType("application/json");
  xhr.open("GET", "/api/load-puzzle", true);
  xhr.send();
}

let board = setInitialBoardState();
// --- End Example JS ----------------------------------------------------------
</script>
</body>
</html>
